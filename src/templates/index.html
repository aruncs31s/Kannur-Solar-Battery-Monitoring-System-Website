<!DOCTYPE html>
<html>
<head>
    <title>Solar Battery Monitor</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        .chart-container {
            width: 45%;
            margin: 20px;
            display: inline-block;
        }
        .dashboard {
            text-align: center;
        }
        .current-values {
            margin: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .control-button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .control-button:hover {
            background-color: #45a049;
        }
        .control-button.active {
            background-color: #e74c3c;
        }
        .button-status {
            margin-top: 10px;
            font-style: italic;
        }
        .device-status {
            margin: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>Solar Charge Monitoring</h1>
        <div class="current-values">
            <h2>Live Readings</h2>
            <!-- <p>Temperature: <span id="temp">--</span>°C</p> -->
            <!-- <p>Humidity: <span id="humidity">--</span>%</p> -->
            <!-- <p>Light Level: <span id="light">--</span></p> -->
            <p>Battery: <span id="battery">--</span>V</p>
            <!-- <p>Rain Volume: <span id="rain">--</span>mm</p> -->
        </div>
        
        <!-- <div id="chart-temp" class="chart-container"></div>
        <div id="chart-humidity" class="chart-container"></div>
        <div id="chart-light" class="chart-container"></div> -->
        <div id="chart-battery" class="chart-container"></div>
        <!-- <div id="chart-rain" class="chart-container"></div> -->
        <div class="control-panel">
            <button id="controlButton" class="control-button">Toggle Control</button>
            <p class="button-status" id="buttonStatus">Status: Inactive</p>
        </div>
        <div class="device-status">
            <h2>Device Status</h2>
            <ul id="deviceList"></ul>
        </div>
    </div>

    <script>
        function createChart(containerId, title, yAxisTitle, seriesName) {
            return Highcharts.chart(containerId, {
                chart: { type: 'line' },
                title: { text: title },
                xAxis: {
                    type: 'datetime',
                    title: { text: 'Time' }
                },
                yAxis: {
                    title: { text: yAxisTitle }
                },
                series: [{
                    name: seriesName,
                    data: []
                }]
            });
        }

        // Initialize charts
        const charts = {
            // temp: createChart('chart-temp', 'Temperature', 'Temperature (°C)', 'Temperature'),
            // humidity: createChart('chart-humidity', 'Humidity', 'Humidity (%)', 'Humidity'),
            // light: createChart('chart-light', 'Light Level', 'Light Level', 'Light'),
            battery: createChart('chart-battery', 'Battery Voltage', 'Voltage (V)', 'Battery'),
            // rain: createChart('chart-rain', 'Rain Volume', 'Volume (mm)', 'Rain')
        };


        const controlButton = document.getElementById('controlButton');
        const buttonStatus = document.getElementById('buttonStatus');
        let isActive = false;

        controlButton.addEventListener('click', function() {
            isActive = !isActive;
            controlButton.classList.toggle('active');
            
            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    state: isActive
                })
            })
            .then(response => response.json())
            .then(data => {
                buttonStatus.textContent = `Status: ${isActive ? 'Active' : 'Inactive'}`;
                if (data.error) {
                    alert('Error: ' + data.error);
                    isActive = !isActive; // Revert state on error
                    controlButton.classList.toggle('active');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send command to ESP8266');
                isActive = !isActive; // Revert state on error
                controlButton.classList.toggle('active');
            });
        });
        function updateDashboard() {
            fetch('/api/data?timeframe=hour')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latest = data[0];
                        
                        // Update current values
                        // document.getElementById('temp').textContent = latest.temperature;
                        // document.getElementById('humidity').textContent = latest.humidity;
                        // document.getElementById('light').textContent = latest.light_sensor_value;
                        document.getElementById('battery').textContent = latest.battery_voltage;
                        // document.getElementById('rain').textContent = latest.rain_volume;

                        // Update charts
                        const chartData = data.reverse().map(reading => ({
                            // temp: [new Date(reading.timestamp).getTime(), reading.temperature],
                            // humidity: [new Date(reading.timestamp).getTime(), reading.humidity],
                            // light: [new Date(reading.timestamp).getTime(), reading.light_sensor_value],
                            battery: [new Date(reading.timestamp).getTime(), reading.battery_voltage],
                            // rain: [new Date(reading.timestamp).getTime(), reading.rain_volume]
                        }));

                        // charts.temp.series[0].setData(chartData.map(d => d.temp));
                        // charts.humidity.series[0].setData(chartData.map(d => d.humidity));
                        // charts.light.series[0].setData(chartData.map(d => d.light));
                        charts.battery.series[0].setData(chartData.map(d => d.battery));
                        // charts.rain.series[0].setData(chartData.map(d => d.rain));
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateDeviceStatus() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(devices => {
                    const deviceList = document.getElementById('deviceList');
                    deviceList.innerHTML = '';
                    devices.forEach(device => {
                        const li = document.createElement('li');
                        li.textContent = `${device.name} - ${device.status}`;
                        deviceList.appendChild(li);
                    });
                })
                .catch(error => console.error('Error fetching device status:', error));
        }

        // Update dashboard every 5 seconds
        setInterval(updateDashboard, 5000);
        updateDashboard();  // Initial update

        // Update device status every 10 seconds
        setInterval(updateDeviceStatus, 10000);
        updateDeviceStatus();  // Initial update
    </script>
</body>
</html>